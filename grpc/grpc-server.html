<script src="node-red-contrib-grpc/certsgen.js"></script>
<script src="node-red-contrib-grpc/forge.min-0.7.0.js"></script>

<!-- ***************** SERVER CONFIG *********************** -->
<script type="text/x-red" data-template-name="grpc-server">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-config-input-server"><i class="fa fa-tag"></i> Server</label>
        <input type="text" id="node-config-input-server" placeholder="Server URL (default 0.0.0.0)">
    </div>
    <div class="form-row">
        <label for="node-config-input-port" style="margin-left: 10px; width: 35px; "> Port</label>
        <input type="text" id="node-config-input-port" placeholder="Port" style="width:45px">		
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-config-input-localServer" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-config-input-localServer" style="width: auto">Start a local server</label>
    </div>
	  <div class="form-row">
        <label for="node-config-input-protoFile"> Proto File</label>
        <textarea id="node-config-input-protoFile" placeholder="Proto File" rows="20" style="width: 100%"></textarea>
    </div>

    <div class="form-row">
      <button id="keygen">Generate bellow</button>
    </div>
    <div class="form-row">
      <input type="checkbox" id="node-config-input-mutualTls" style="display: inline-block; width: auto; vertical-align: top;">
      <label for="node-config-input-mutualTls" style="width: auto">Mutual TLS?</label>
    </div>
    <div class="form-row">
          <label for="node-config-input-ca">CA Cert</label>
          <textarea id="node-config-input-ca" placeholder="CA Cert" rows="10" style="width: 100%"></textarea>
      </div>
    <div class="form-row">
          <label for="node-config-input-chain">Chain Cert</label>
          <textarea id="node-config-input-chain" placeholder="Chain Cert" rows="10" style="width: 100%"></textarea>
      </div>
    <div class="form-row">
        <label for="node-config-input-key">Private Key</label>
        <textarea id="node-config-input-key" placeholder="Private Key" rows="10" style="width: 100%"></textarea>
    </div> 
</script>

<script type="text/javascript">
    RED.nodes.registerType('grpc-server', {
        category: 'config',
        defaults: {
            port: {
                value: 5001,
                required: true,
                validate: RED.validators.number()
            },
            name: { value: '' },
            server: { value: '' },
            protoFile: { value: '' },
            ca: { value: '' },
            caPrivateKey: { value: '' },
            cacert: { value: '' },
            caName: { value: '' },
            caOrgName: { value: '' },
            chain: { value: '' },
            key: { value: '' },
            mutualTls: { value: false },
            localServer: { value : true },
        },
        icon: "grpc.svg",
        color: "#2DA6B0",
        label: function () {
            return (this.name || "localhost") + ":" + this.port;
        },
        oneditprepare: function (){
          var that = this;

          $("#keygen").click(() => {
            console.log(this);
            const { cacert, caPrivateKey } = caCertGen();
            document.getElementById('node-config-input-ca').value = cacert;
      
            const serverName = document.getElementById('node-config-input-server').value;
            const nodeName = document.getElementById('node-config-input-name').value;
            
            const { cert, privateKey } = certGen(cacert, caPrivateKey, serverName, nodeName);
            document.getElementById('node-config-input-chain').value = cert;
            document.getElementById('node-config-input-key').value = privateKey;

            that.caPrivateKey = caPrivateKey;
            that.cacert = cacert;
          })
        }
    });
</script>